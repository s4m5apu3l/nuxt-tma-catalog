import{u as b,I as C,Q as y}from"./DMR9fnoT.js";import{u as q}from"./DEEDW1PH.js";import{r as f,U as F,M as p}from"./NM7yOJlJ.js";const g=t=>({...t,name:typeof t.name=="string"?JSON.parse(t.name):t.name,description:typeof t.description=="string"?JSON.parse(t.description):t.description,features:typeof t.features=="string"?JSON.parse(t.features):t.features,contactMessage:typeof t.contactMessage=="string"?JSON.parse(t.contactMessage):t.contactMessage,pricing:typeof t.pricing=="string"?JSON.parse(t.pricing):t.pricing||[]}),u=f([]),s=f(!1),o=f(null),N=f(0),U=300*1e3,I=()=>{const t=f(null),{databases:i}=b(),{handleError:v}=q(),m=F(),a=m.public.appwriteBdKey,c=m.public.appwriteCollectionProducts,O=()=>Date.now()-N.value<U&&u.value.length>0,h=async(r,e=!1)=>{if(!e&&!r&&O())return u.value;s.value=!0,o.value=null;try{const n=[y.equal("isActive",!0),y.orderDesc("$createdAt")];r&&n.push(y.equal("categoryId",r));const l=(await i.listDocuments(a,c,n)).documents.map(g);return r||(u.value=l,N.value=Date.now()),l}catch(n){throw o.value=n instanceof Error?n.message:"Unknown error",n}finally{s.value=!1}},S=async r=>{s.value=!0,o.value=null;try{const e=await i.getDocument(a,c,r);return t.value=g(e),t.value}catch(e){throw o.value=e instanceof Error?e.message:"Unknown error",e}finally{s.value=!1}},w=async()=>h(void 0,!0),J=async r=>{s.value=!0,o.value=null;try{const e=await i.createDocument(a,c,C.unique(),{...r,name:JSON.stringify(r.name),description:JSON.stringify(r.description),features:JSON.stringify(r.features||[]),contactMessage:JSON.stringify(r.contactMessage||{}),pricing:JSON.stringify(r.pricing||[]),isActive:r.isActive??!0}),n=g(e);return u.value.unshift(n),n}catch(e){return console.error("Error creating product:",e),o.value="Failed to create product",v(e,"Ошибка создания товара"),null}finally{s.value=!1}},P=async(r,e)=>{s.value=!0,o.value=null;try{const n=await i.updateDocument(a,c,r,{...e,name:e.name?JSON.stringify(e.name):void 0,description:e.description?JSON.stringify(e.description):void 0,features:e.features?JSON.stringify(e.features):void 0,contactMessage:e.contactMessage?JSON.stringify(e.contactMessage):void 0,pricing:e.pricing?JSON.stringify(e.pricing):void 0}),d=g(n),l=u.value.findIndex(A=>A.$id===r);return l!==-1&&(u.value[l]=d),d}catch(n){return console.error("Error updating product:",n),o.value="Failed to update product",v(n,"Ошибка обновления товара"),null}finally{s.value=!1}},D=async r=>{s.value=!0,o.value=null;try{return await i.deleteDocument(a,c,r),u.value=u.value.filter(e=>e.$id!==r),!0}catch(e){return console.error("Error deleting product:",e),o.value="Failed to delete product",v(e,"Ошибка удаления товара"),!1}finally{s.value=!1}},M=r=>u.value.find(e=>e.slug===r),E=r=>u.value.find(e=>e.$id===r);return{products:p(u),product:p(t),isLoading:p(s),loading:p(s),error:p(o),fetchProducts:h,fetchProduct:S,fetchAllProducts:w,createProduct:J,updateProduct:P,deleteProduct:D,getProductBySlug:M,getProductById:E}};export{I as u};
