<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Share Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #006699;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .url-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Telegram Share Functionality Test</h1>
    <p>This page tests the Telegram sharing functionality that will be used in the TMA Catalog product detail pages.</p>

    <div class="test-section">
        <h2>Test 1: Basic Product Share</h2>
        <p>Test sharing a basic product with title, price, and description.</p>
        <button class="test-button" onclick="testBasicShare()">Test Basic Share</button>
        <div id="basic-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Product Without Description</h2>
        <p>Test sharing a product that has no description.</p>
        <button class="test-button" onclick="testNoDescriptionShare()">Test No Description Share</button>
        <div id="no-desc-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Product with Long Description</h2>
        <p>Test sharing a product with a very long description (should be truncated).</p>
        <button class="test-button" onclick="testLongDescriptionShare()">Test Long Description Share</button>
        <div id="long-desc-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Product with Special Characters</h2>
        <p>Test sharing a product with special characters, emojis, and symbols.</p>
        <button class="test-button" onclick="testSpecialCharsShare()">Test Special Characters Share</button>
        <div id="special-chars-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: URL Validation</h2>
        <p>Test URL validation functionality.</p>
        <button class="test-button" onclick="testUrlValidation()">Test URL Validation</button>
        <div id="url-validation-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 6: Text Validation</h2>
        <p>Test text validation functionality.</p>
        <button class="test-button" onclick="testTextValidation()">Test Text Validation</button>
        <div id="text-validation-result"></div>
    </div>

    <script>
        // Telegram Share Implementation (simplified version of the composable)
        class TelegramShare {
            constructor() {
                this.isSharing = false;
                this.error = null;
            }

            validateShareUrl(url) {
                try {
                    const urlObj = new URL(url);
                    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
                } catch {
                    return false;
                }
            }

            validateShareText(text) {
                return text.trim().length > 0 && text.length <= 4096;
            }

            generateTelegramShareUrl(options) {
                try {
                    this.error = null;

                    if (!this.validateShareUrl(options.url)) {
                        this.error = 'Invalid URL provided for sharing';
                        return null;
                    }

                    if (!this.validateShareText(options.text)) {
                        this.error = 'Share text is required and must be less than 4096 characters';
                        return null;
                    }

                    const telegramBaseUrl = 'https://t.me/share/url';
                    const params = new URLSearchParams({
                        url: options.url,
                        text: options.text
                    });

                    return `${telegramBaseUrl}?${params.toString()}`;
                } catch (error) {
                    console.error('Generate Telegram share URL error:', error);
                    this.error = 'Failed to generate share URL';
                    return null;
                }
            }

            async shareOnTelegram(options) {
                try {
                    this.isSharing = true;
                    this.error = null;

                    const shareUrl = this.generateTelegramShareUrl(options);
                    if (!shareUrl) {
                        return false;
                    }

                    const shareWindow = window.open(shareUrl, '_blank', 'noopener,noreferrer');
                    
                    if (!shareWindow) {
                        this.error = 'Failed to open share window. Please check your popup blocker settings.';
                        return false;
                    }

                    return true;
                } catch (error) {
                    console.error('Share on Telegram error:', error);
                    this.error = 'Failed to share on Telegram. Please try again.';
                    return false;
                } finally {
                    this.isSharing = false;
                }
            }

            async shareProduct(product, productUrl) {
                try {
                    const formattedPrice = new Intl.NumberFormat('ru-RU', {
                        style: 'currency',
                        currency: 'RUB'
                    }).format(product.price);

                    let shareText = `${product.title} - ${formattedPrice}`;
                    
                    if (product.description && product.description.trim().length > 0) {
                        const maxDescLength = 200;
                        const description = product.description.length > maxDescLength 
                            ? `${product.description.substring(0, maxDescLength)}...`
                            : product.description;
                        
                        shareText += `\n\n${description}`;
                    }

                    return await this.shareOnTelegram({
                        url: productUrl,
                        text: shareText
                    });
                } catch (error) {
                    console.error('Share product error:', error);
                    this.error = 'Failed to share product. Please try again.';
                    return false;
                }
            }
        }

        const telegramShare = new TelegramShare();

        function displayResult(elementId, success, message, url = null) {
            const element = document.getElementById(elementId);
            const className = success ? 'success' : 'error';
            let html = `<div class="test-result ${className}">${message}</div>`;
            
            if (url) {
                html += `<div class="url-display"><strong>Generated URL:</strong><br>${url}</div>`;
            }
            
            element.innerHTML = html;
        }

        function testBasicShare() {
            const product = {
                title: 'Test Product',
                price: 1500.50,
                description: 'This is a test product with a detailed description for sharing on Telegram.'
            };
            const productUrl = 'https://example.com/product/123';

            const shareUrl = telegramShare.generateTelegramShareUrl({
                url: productUrl,
                text: `${product.title} - ${new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(product.price)}\n\n${product.description}`
            });

            if (shareUrl) {
                displayResult('basic-result', true, 'Share URL generated successfully! Click the URL below to test in Telegram.', shareUrl);
            } else {
                displayResult('basic-result', false, `Failed to generate share URL: ${telegramShare.error}`);
            }
        }

        function testNoDescriptionShare() {
            const product = {
                title: 'Simple Product',
                price: 999.99
            };
            const productUrl = 'https://example.com/product/456';

            const shareUrl = telegramShare.generateTelegramShareUrl({
                url: productUrl,
                text: `${product.title} - ${new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(product.price)}`
            });

            if (shareUrl) {
                displayResult('no-desc-result', true, 'Share URL generated successfully for product without description!', shareUrl);
            } else {
                displayResult('no-desc-result', false, `Failed to generate share URL: ${telegramShare.error}`);
            }
        }

        function testLongDescriptionShare() {
            const longDescription = 'This is a very long product description that should be truncated when shared on Telegram because it exceeds the recommended length for sharing. '.repeat(5);
            const product = {
                title: 'Product with Long Description',
                price: 2500.00,
                description: longDescription
            };
            const productUrl = 'https://example.com/product/789';

            const truncatedDesc = longDescription.length > 200 ? `${longDescription.substring(0, 200)}...` : longDescription;
            const shareUrl = telegramShare.generateTelegramShareUrl({
                url: productUrl,
                text: `${product.title} - ${new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(product.price)}\n\n${truncatedDesc}`
            });

            if (shareUrl) {
                displayResult('long-desc-result', true, 'Share URL generated successfully with truncated description!', shareUrl);
            } else {
                displayResult('long-desc-result', false, `Failed to generate share URL: ${telegramShare.error}`);
            }
        }

        function testSpecialCharsShare() {
            const product = {
                title: 'Product with "quotes" & symbols! ðŸŽ‰',
                price: 1234.56,
                description: 'Description with Ã©mojis ðŸŽ‰ and special chars: @#$%^&*()_+-=[]{}|;:,.<>?'
            };
            const productUrl = 'https://example.com/product/special';

            const shareUrl = telegramShare.generateTelegramShareUrl({
                url: productUrl,
                text: `${product.title} - ${new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(product.price)}\n\n${product.description}`
            });

            if (shareUrl) {
                displayResult('special-chars-result', true, 'Share URL generated successfully with special characters!', shareUrl);
            } else {
                displayResult('special-chars-result', false, `Failed to generate share URL: ${telegramShare.error}`);
            }
        }

        function testUrlValidation() {
            const testUrls = [
                { url: 'https://example.com', expected: true },
                { url: 'http://localhost:3000', expected: true },
                { url: 'https://example.com/path?query=value', expected: true },
                { url: 'not-a-url', expected: false },
                { url: 'ftp://example.com', expected: false },
                { url: '', expected: false },
                { url: 'javascript:alert(1)', expected: false }
            ];

            let results = [];
            let allPassed = true;

            testUrls.forEach(test => {
                const result = telegramShare.validateShareUrl(test.url);
                const passed = result === test.expected;
                if (!passed) allPassed = false;
                results.push(`${test.url || '(empty)'}: ${passed ? 'PASS' : 'FAIL'} (expected: ${test.expected}, got: ${result})`);
            });

            const message = allPassed ? 'All URL validation tests passed!' : 'Some URL validation tests failed!';
            displayResult('url-validation-result', allPassed, `${message}\n\n${results.join('\n')}`);
        }

        function testTextValidation() {
            const testTexts = [
                { text: 'Valid share text', expected: true },
                { text: 'a'.repeat(4096), expected: true },
                { text: '', expected: false },
                { text: '   ', expected: false },
                { text: 'a'.repeat(4097), expected: false }
            ];

            let results = [];
            let allPassed = true;

            testTexts.forEach(test => {
                const result = telegramShare.validateShareText(test.text);
                const passed = result === test.expected;
                if (!passed) allPassed = false;
                const displayText = test.text.length > 50 ? `${test.text.substring(0, 50)}... (${test.text.length} chars)` : test.text || '(empty)';
                results.push(`"${displayText}": ${passed ? 'PASS' : 'FAIL'} (expected: ${test.expected}, got: ${result})`);
            });

            const message = allPassed ? 'All text validation tests passed!' : 'Some text validation tests failed!';
            displayResult('text-validation-result', allPassed, `${message}\n\n${results.join('\n')}`);
        }
    </script>
</body>
</html>